# COC克苏鲁跑团工具集合

这是一个基于RAG（检索增强生成）技术的COC（克苏鲁的呼唤）跑团辅助工具集合，包含两个主要应用：

## 🔍 COC规则助手
基于COC第六版规则的智能问答系统，帮助KP和玩家快速查询规则。

## 🎭 KP叙事辅助工具
专为守秘人设计的AI叙事伙伴，通过四层信息输入结构生成高质量游戏描述。

## 功能特点

### COC规则助手
- 🎭 **智能问答**: 基于COC第六版规则的智能问答系统
- 🐙 **主题化界面**: 充满克苏鲁神话氛围的用户界面
- 📚 **RAG技术**: 使用向量数据库检索相关规则内容
- 💬 **聊天记录**: 自动保存和管理聊天历史
- 🎲 **随机问题**: 内置常见问题快速查询

### KP叙事辅助工具
- 🎪 **四层信息结构**: 剧本概要、当前阶段、玩家选择、聊天记录
- 🎬 **智能叙事生成**: 基于设定和玩家行动生成连贯描述
- 🎯 **情境感知**: 结合知识库和上下文的精准响应
- 📝 **会话管理**: 自动保持剧本概要和当前阶段设定
- 🎭 **氛围营造**: 维持克苏鲁神话特有的恐怖神秘氛围

## 项目结构

```
coc_trial/
├── config.py                    # 配置文件
├── main_app.py                  # 主应用逻辑（RAG系统）
├── streamlit_app.py             # COC规则助手界面
├── kp_narrative_app.py          # KP叙事辅助工具界面
├── app_launcher.py              # 应用选择器界面
├── start_tools.py               # 启动脚本
├── requirements.txt             # 依赖包列表
├── README.md                   # 说明文档
├── rag_documents.txt           # RAG知识库源文件
├── chat_logs.json              # 聊天记录（自动生成）
├── narrative_logs.json         # 叙事记录（自动生成）
└── faiss_index/                # 向量索引文件夹（自动生成）
```

## 安装与配置

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 获取API密钥

- **DashScope API**: 访问 [阿里云DashScope](https://dashscope.aliyun.com/) 注册并获取API密钥

**注意**：现在您可以直接在应用界面中输入API密钥，无需修改配置文件。

### 3. 配置API密钥（可选）

如果需要在配置文件中预设API密钥，可以在 `config.py` 文件中配置：

```python
# DashScope API配置
EMBEDDING_API_KEY = "your_dashscope_api_key_here"
LLM_API_KEY = "your_dashscope_api_key_here"
```

或者使用环境变量：

```bash
export DASHSCOPE_API_KEY="your_dashscope_api_key"
```

## 运行应用

### 🚀 快速启动（推荐）

使用启动脚本，可以方便地选择和启动不同的工具：

```bash
python start_tools.py
```

### 🌐 应用选择器

启动应用选择器，在一个界面中选择要使用的工具：

```bash
streamlit run app_launcher.py --server.port 8500
```

### 🔍 单独启动COC规则助手

```bash
streamlit run streamlit_app.py --server.port 8501
```

### 🎭 单独启动KP叙事工具

```bash
streamlit run kp_narrative_app.py --server.port 8502
```

### 📍 访问地址

- 应用选择器: `http://localhost:8500`
- COC规则助手: `http://localhost:8501`
- KP叙事工具: `http://localhost:8502`

### 测试主应用

```bash
python main_app.py
```

## 使用指南

### 🔍 COC规则助手使用

1. **询问规则**: 直接输入COC规则相关的问题
   - "什么是理智检定？"
   - "如何创建调查员角色？"
   - "战斗系统如何运作？"

2. **角色创建**: 获取角色创建的建议和指导
   - "调查员的属性有哪些？"
   - "职业技能如何分配？"

3. **游戏机制**: 了解各种游戏机制
   - "技能检定如何进行？"
   - "疯狂规则是什么？"

**界面功能**：
- **API配置**: 在侧边栏输入DashScope API密钥
- **发送按钮**: 发送你的问题
- **随机问题**: 随机选择一个常见问题
- **清空会话**: 清除当前聊天记录
- **状态显示**: 查看应用状态和统计信息

### 🎭 KP叙事辅助工具使用

#### 四层信息输入结构

1. **剧本概要**（全局背景）
   - 设定故事的整体背景和世界观
   - 首次使用时必须设定，之后会自动保持
   - 例子：一个发生在1920年代阿卡姆镇的恐怖故事...

2. **当前剧情阶段**（场景信息）
   - 描述当前场景的静态信息
   - 场景切换时需要更新
   - 例子：调查员们来到废弃的威尔逊庄园...

3. **玩家选择**（动态触发器）
   - 输入玩家的具体行动或选择
   - **必填项**，每次生成叙事都需要输入
   - 例子：玩家决定仔细搜查大厅，寻找线索...

4. **聊天记录**（上下文）
   - 系统自动管理，提供叙事连贯性
   - 保留最近的对话历史作为上下文

#### 使用流程

1. **API配置**: 在侧边栏输入DashScope API密钥
2. **初始设定**: 首次使用时填写剧本概要和当前阶段
3. **叙事生成**: 输入玩家行动，点击"生成叙事"
4. **场景切换**: 需要时更新当前阶段设定
5. **持续互动**: 继续输入玩家行动获取AI叙事响应

**特殊功能**：
- **示例场景**: 点击"示例场景"快速体验功能
- **设定保持**: 剧本概要和当前阶段会在会话中保持
- **叙事记录**: 所有叙事内容自动保存
- **知识库集成**: AI会根据玩家行动检索相关COC规则

## 技术架构

### RAG系统

1. **文档处理**: 将COC规则文档分割成语义块
2. **向量化**: 使用DashScope嵌入模型将文本转换为向量
3. **索引存储**: 使用FAISS向量数据库存储和检索
4. **相似度搜索**: 根据用户问题检索最相关的规则内容

### LLM集成

- 使用OpenAI GPT-3.5-turbo模型
- 基于检索到的相关内容生成回答
- 专门针对COC游戏场景优化的提示词

## 自定义配置

### 修改检索参数

在 `config.py` 中调整：

```python
CHUNK_SIZE = 500        # 文档块大小
CHUNK_OVERLAP = 50      # 块重叠大小  
TOP_K = 5              # 检索返回的文档数量
```

### 修改系统提示词

在 `config.py` 中修改 `SYSTEM_PROMPT` 来调整AI的回答风格。

## 故障排除

### 常见问题

1. **RAG系统初始化失败**
   - 检查 `rag_documents.txt` 文件是否存在
   - 确认DashScope API密钥配置正确

2. **LLM响应错误**
   - 检查OpenAI API密钥配置
   - 确认网络连接正常

3. **向量索引构建失败**
   - 删除 `faiss_index` 文件夹重新构建
   - 检查磁盘空间是否充足

### 调试模式

查看详细日志：

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## 贡献

欢迎提交Issue和Pull Request来改进这个项目！

## 许可证

本项目仅供学习和个人使用。COC规则内容版权归Chaosium Inc.所有。

---

*"我们生活在一个平静的无知之岛上，被漆黑的无尽海洋包围，而我们并不应该航行过远。" - H.P. Lovecraft*
# coc_helper
# coc_helper
